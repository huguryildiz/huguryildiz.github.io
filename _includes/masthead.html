{% include base_path %}
<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">

        <!-- =========================================================
             Site title
             - Keep this ALWAYS visible (persist)
             ========================================================= -->
        <a class="site-title persist" href="{{ base_path }}/">
          {{ site.title }}
        </a>

        <!-- =========================================================
             Primary navigation links
             - IMPORTANT:
             - Do NOT mark CV/Publications/Research as "persist"
             - Greedy-nav will move overflow items into .hidden-links on mobile
             ========================================================= -->
        <ul class="visible-links">
          {% for link in site.data.navigation.main %}
            {% if link.url contains 'http' %}
              {% assign domain = '' %}
            {% else %}
              {% assign domain = base_path %}
            {% endif %}

            <li class="masthead__menu-item{% if page.url contains link.url and link.url != '/' %} selected{% endif %}">
              <a href="{{ domain }}{{ link.url }}">{{ link.title }}</a>
            </li>
          {% endfor %}

          <!-- =========================================================
               Theme toggle
               - Keep it ALWAYS visible (persist)
               - It should NOT go into hamburger
               ========================================================= -->
          <li id="theme-toggle" class="masthead__menu-item persist">
            <a href="#" role="button" aria-label="Toggle theme">
              <i id="theme-icon" class="fas fa-sun" aria-hidden="true" title="Toggle theme"></i>
            </a>
          </li>
        </ul>

        <!-- =========================================================
             Hamburger button (Minimal Mistakes Greedy Nav expects this)
             - Greedy-nav JS toggles .hidden-links with this button
             ========================================================= -->
        <button class="greedy-nav__toggle hidden" type="button" aria-label="Toggle menu">
          <span class="navicon"></span>
        </button>

        <!-- =========================================================
             Hidden links container
             - Greedy-nav JS moves overflow items here (hamburger menu)
             ========================================================= -->
        <ul class="hidden-links hidden"></ul>

      </nav>
    </div>
  </div>
</div>

<style>
/* =========================================================
   Mobile: layout adjustments
   - Ensure theme toggle stays visible next to hamburger
   - Ensure it doesn't overlap the hamburger button
   ========================================================= */
@media (max-width: 768px) {
  .greedy-nav {
    position: relative;
    overflow: visible;
  }

  /* Pin the theme icon near the hamburger (left of it) */
  #theme-toggle {
    position: absolute;
    right: 3.3rem;  /* adjust if it overlaps hamburger */
    top: 0.55rem;
    z-index: 9999;
    display: list-item !important;
  }

  #theme-toggle a {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px 10px;
    text-decoration: none !important;
    cursor: pointer;
  }

  #theme-toggle i {
    display: inline-block;
    width: 1.25em;
    line-height: 1;
    font-size: 1.15rem;
  }
}
</style>

<script>
/* =========================================================
   Force ALL nav links into hamburger on mobile (robust)
   - Runs AFTER all theme scripts are loaded (window.load)
   - Re-applies on resize/orientation changes
   ========================================================= */
(function () {
  const MOBILE_MAX = 768;

  function forceAllLinksIntoHamburger() {
    const nav = document.getElementById("site-nav");
    if (!nav) return;

    const visible = nav.querySelector(".visible-links");
    const hidden  = nav.querySelector(".hidden-links");
    const toggle  = nav.querySelector(".greedy-nav__toggle");
    if (!visible || !hidden || !toggle) return;

    const isMobile = window.innerWidth <= MOBILE_MAX;

    // If not mobile: put items back (so desktop works normally)
    if (!isMobile) {
      // Move back only items that were moved by us
      const movedBack = Array.from(hidden.querySelectorAll("li[data-moved='1']"));
      movedBack.forEach(li => {
        li.removeAttribute("data-moved");
        // Insert before the theme toggle if it exists, otherwise append
        const themeLi = visible.querySelector("#theme-toggle");
        if (themeLi) visible.insertBefore(li, themeLi);
        else visible.appendChild(li);
      });
      nav.dataset.mobileForced = "0";
      return;
    }

    // Mobile: prevent repeated work
    if (nav.dataset.mobileForced === "1") return;
    nav.dataset.mobileForced = "1";

    // Ensure hamburger button is not hidden
    toggle.classList.remove("hidden");

    // Move every non-persist <li> from visible-links into hidden-links
    const items = Array.from(visible.querySelectorAll("li"))
      .filter(li => !li.classList.contains("persist") && li.id !== "theme-toggle");

    items.forEach(li => {
      li.setAttribute("data-moved", "1");
      hidden.appendChild(li);
    });
  }

  // Run after ALL scripts/resources load (greedy-nav fully initialized)
  window.addEventListener("load", function () {
    forceAllLinksIntoHamburger();
  });

  // Re-apply on resize/orientation changes
  window.addEventListener("resize", function () {
    // Small debounce
    clearTimeout(window.__navForceTO);
    window.__navForceTO = setTimeout(forceAllLinksIntoHamburger, 120);
  });

  window.addEventListener("orientationchange", function () {
    setTimeout(forceAllLinksIntoHamburger, 150);
  });
})();
</script>