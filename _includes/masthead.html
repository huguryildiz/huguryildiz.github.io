{% include base_path %}
<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">

        <!-- =========================================================
             Greedy nav visible links (Minimal Mistakes default structure)
             ========================================================= -->
        <ul class="visible-links">
          <li class="masthead__menu-item masthead__menu-item--lg persist {% if page.url == '/' or page.url == '/index.html' %}selected{% endif %}">
            <a href="{{ base_path }}/">{{ site.title }}</a>
          </li>

          {% for link in site.data.navigation.main %}
            {% if link.url contains 'http' %}
              {% assign domain = '' %}
            {% else %}
              {% assign domain = base_path %}
            {% endif %}
            <li class="masthead__menu-item {% if page.url contains link.url and link.url != '/' %}selected{% endif %}">
              <a href="{{ domain }}{{ link.url }}">{{ link.title }}</a>
            </li>
          {% endfor %}

          <!-- =========================================================
               Theme toggle (SINGLE source of truth for desktop + mobile)
               - We DO NOT create a separate mobile toggle button.
               - On mobile, we simply reposition this icon next to the hamburger.
               ========================================================= -->
          <li id="theme-toggle" class="masthead__menu-item persist">
            <a href="#" role="button" aria-label="Toggle theme">
              <!-- Icon is set by JS on load: sun (light) / moon (dark) -->
              <i id="theme-icon" class="fas fa-sun" aria-hidden="true" title="Toggle theme"></i>
            </a>
          </li>
        </ul>

        <!-- Minimal Mistakes will move overflow items here -->
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

<style>
/* =========================================================
   Mobile theme toggle positioning (Greedy-nav safe)
   - Keeps Minimal Mistakes greedy-nav intact.
   - Only repositions the existing theme toggle icon on small screens.
   ========================================================= */
@media (max-width: 768px) {
  /* Ensure the nav can show the absolutely positioned icon */
  .greedy-nav {
    position: relative;
    overflow: visible;
  }

  /*
    Minimal Mistakes often hides non-persist items on mobile,
    but our theme toggle is persist so it should remain.
    Still, force it visible just in case other custom rules exist.
  */
  #theme-toggle {
    display: list-item !important;
    visibility: visible !important;
    opacity: 1 !important;

    /* Place next to hamburger (adjust right/top if needed) */
    position: absolute;
    right: 3.2rem;  /* leave space for the hamburger button */
    top: 0.55rem;
    z-index: 9999;
  }

  #theme-toggle a {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px 10px;
    text-decoration: none !important;
    cursor: pointer;
  }

  #theme-toggle i {
    display: inline-block;
    width: 1.25em;
    line-height: 1;
  }
}
</style>

<script>
/**
 * Theme handling (single toggle for desktop + mobile)
 *
 * What this does:
 * 1) On first load, sets theme based on localStorage or system preference.
 * 2) Toggles theme via the single icon (#theme-toggle).
 * 3) Keeps the icon in sync (sun for light, moon for dark).
 *
 * CSS hooks used:
 * - html.dark
 * - [data-theme="dark"]
 */
(function () {
  const KEY = "theme"; // "dark" | "light"

  function setIcon(theme) {
    const icon = document.getElementById("theme-icon");
    if (!icon) return;
    icon.classList.remove("fa-sun", "fa-moon");
    icon.classList.add(theme === "dark" ? "fa-moon" : "fa-sun");
  }

  function applyTheme(theme) {
    const root = document.documentElement;
    root.classList.toggle("dark", theme === "dark");
    root.setAttribute("data-theme", theme);
    setIcon(theme);
  }

  function getInitialTheme() {
    try {
      const saved = localStorage.getItem(KEY);
      if (saved === "dark" || saved === "light") return saved;
    } catch (e) {}

    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;

    return prefersDark ? "dark" : "light";
  }

  function toggleTheme() {
    const isDark = document.documentElement.classList.contains("dark");
    const next = isDark ? "light" : "dark";
    try { localStorage.setItem(KEY, next); } catch (e) {}
    applyTheme(next);
  }

  /* Apply early to reduce flash */
  applyTheme(getInitialTheme());

  document.addEventListener("DOMContentLoaded", function () {
    const btn = document.querySelector("#theme-toggle a");
    if (btn) {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        toggleTheme();
      });
    }

    /* Follow system theme changes ONLY if user has not saved a preference */
    const mq = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)");
    if (mq && mq.addEventListener) {
      mq.addEventListener("change", function (e) {
        let saved = null;
        try { saved = localStorage.getItem(KEY); } catch (err) {}
        if (!saved) applyTheme(e.matches ? "dark" : "light");
      });
    }
  });
})();
</script>