{% include base_path %}
<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">

        <!-- =========================================================
             Site title
             - Keep this ALWAYS visible (persist)
             ========================================================= -->
        <a class="site-title persist" href="{{ base_path }}/">
          {{ site.title }}
        </a>

        <!-- =========================================================
             Primary navigation links
             - IMPORTANT:
             - Do NOT mark CV/Publications/Research as "persist"
             - Greedy-nav will move overflow items into .hidden-links on mobile
             ========================================================= -->
        <ul class="visible-links">
          {% for link in site.data.navigation.main %}
            {% if link.url contains 'http' %}
              {% assign domain = '' %}
            {% else %}
              {% assign domain = base_path %}
            {% endif %}

            <li class="masthead__menu-item{% if page.url contains link.url and link.url != '/' %} selected{% endif %}">
              <a href="{{ domain }}{{ link.url }}">{{ link.title }}</a>
            </li>
          {% endfor %}

          <!-- =========================================================
               Theme toggle
               - Keep it ALWAYS visible (persist)
               - It should NOT go into hamburger
               ========================================================= -->
          <li id="theme-toggle" class="masthead__menu-item persist">
            <a href="#" role="button" aria-label="Toggle theme">
              <i id="theme-icon" class="fas fa-sun" aria-hidden="true" title="Toggle theme"></i>
            </a>
          </li>
        </ul>

        <!-- =========================================================
             Hamburger button (Minimal Mistakes Greedy Nav expects this)
             - Greedy-nav JS toggles .hidden-links with this button
             ========================================================= -->
        <button class="greedy-nav__toggle hidden" type="button" aria-label="Toggle menu">
          <span class="navicon"></span>
        </button>

        <!-- =========================================================
             Hidden links container
             - Greedy-nav JS moves overflow items here (hamburger menu)
             ========================================================= -->
        <ul class="hidden-links hidden"></ul>

      </nav>
    </div>
  </div>
</div>

<style>
/* =========================================================
   Mobile: layout adjustments
   - Ensure theme toggle stays visible next to hamburger
   - Ensure it doesn't overlap the hamburger button
   ========================================================= */
@media (max-width: 768px) {
  .greedy-nav {
    position: relative;
    overflow: visible;
  }

  /* Pin the theme icon near the hamburger (left of it) */
  #theme-toggle {
    position: absolute;
    right: 3.3rem;  /* adjust if it overlaps hamburger */
    top: 0.55rem;
    z-index: 9999;
    display: list-item !important;
  }

  #theme-toggle a {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px 10px;
    text-decoration: none !important;
    cursor: pointer;
  }

  #theme-toggle i {
    display: inline-block;
    width: 1.25em;
    line-height: 1;
    font-size: 1.15rem;
  }
}
</style>

<script>
/**
 * Theme handling (single toggle for desktop + mobile)
 *
 * Behavior:
 * 1) On load: localStorage preference > system preference
 * 2) Toggle on click
 * 3) Update icon (sun for light, moon for dark)
 * 4) Follow system changes only if user has no saved preference
 *
 * CSS hooks used:
 * - html.dark
 * - [data-theme="dark"]
 */
(function () {
  const KEY = "theme"; // "dark" | "light"

  function setIcon(theme) {
    const icon = document.getElementById("theme-icon");
    if (!icon) return;
    icon.classList.remove("fa-sun", "fa-moon");
    icon.classList.add(theme === "dark" ? "fa-moon" : "fa-sun");
  }

  function applyTheme(theme) {
    const root = document.documentElement;
    root.classList.toggle("dark", theme === "dark");
    root.setAttribute("data-theme", theme);
    setIcon(theme);
  }

  function getInitialTheme() {
    try {
      const saved = localStorage.getItem(KEY);
      if (saved === "dark" || saved === "light") return saved;
    } catch (e) {}

    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;

    return prefersDark ? "dark" : "light";
  }

  function toggleTheme() {
    const isDark = document.documentElement.classList.contains("dark");
    const next = isDark ? "light" : "dark";
    try { localStorage.setItem(KEY, next); } catch (e) {}
    applyTheme(next);
  }

  /* Apply early to reduce flash */
  applyTheme(getInitialTheme());

  document.addEventListener("DOMContentLoaded", function () {
    const btn = document.querySelector("#theme-toggle a");
    if (btn) {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        toggleTheme();
      });
    }

    const mq = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)");
    if (mq && mq.addEventListener) {
      mq.addEventListener("change", function (e) {
        let saved = null;
        try { saved = localStorage.getItem(KEY); } catch (err) {}
        if (!saved) applyTheme(e.matches ? "dark" : "light");
      });
    }
  });
})();
</script>