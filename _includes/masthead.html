<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav" aria-label="Primary navigation">

        <!-- Site title -->
        <a class="site-title" href="{{ base_path }}/">
          {{ site.title }}
        </a>

        <!-- Main nav links -->
        <ul class="visible-links">
          {% for link in site.data.navigation.main %}
            <li class="masthead__menu-item">
              <a href="{{ domain }}{{ link.url }}">{{ link.title }}</a>
            </li>
          {% endfor %}
        </ul>

        <!-- Right side controls -->
        <div class="masthead-controls" aria-label="Controls">
          <!-- Theme toggle (ALWAYS visible) -->
          <button id="theme-toggle" class="theme-toggle" type="button" aria-label="Toggle theme">
            <i id="theme-icon" class="fas fa-moon" aria-hidden="true"></i>
          </button>

          <!-- Hamburger -->
          <button class="greedy-nav__toggle" type="button" aria-label="Toggle menu">
            <span class="navicon"></span>
          </button>
        </div>

        <!-- Overflow links (greedy-nav fills this) -->
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

<script>
(function () {
  const KEY = "theme"; // "dark" | "light"

  function setIcon(theme) {
    const icon = document.getElementById("theme-icon");
    if (!icon) return;
    icon.classList.remove("fa-sun", "fa-moon");
    icon.classList.add(theme === "dark" ? "fa-moon" : "fa-sun");
  }

  function applyTheme(theme) {
    const root = document.documentElement;
    root.classList.toggle("dark", theme === "dark");
    root.setAttribute("data-theme", theme);
    setIcon(theme);
  }

  function getInitialTheme() {
    try {
      const saved = localStorage.getItem(KEY);
      if (saved === "dark" || saved === "light") return saved;
    } catch (e) {}
    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    return prefersDark ? "dark" : "light";
  }

  function toggleTheme() {
    const isDark = document.documentElement.classList.contains("dark");
    const next = isDark ? "light" : "dark";
    try { localStorage.setItem(KEY, next); } catch (e) {}
    applyTheme(next);
  }

  // Apply on load
  applyTheme(getInitialTheme());

  // React to OS theme changes (only if user hasn't set manual preference)
  try{
    const mql = window.matchMedia("(prefers-color-scheme: dark)");
    mql.addEventListener("change", function(){
      const saved = localStorage.getItem(KEY);
      if(saved !== "dark" && saved !== "light"){
        applyTheme(mql.matches ? "dark" : "light");
      }
    });
  } catch(e){}

  document.addEventListener("DOMContentLoaded", function () {
    const btn = document.getElementById("theme-toggle");
    if (btn) btn.addEventListener("click", toggleTheme);
  });
})();
</script>