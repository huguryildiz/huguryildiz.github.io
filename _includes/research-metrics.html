<!-- _includes/research-metrics.html
     ═══════════════════════════════════════════════════════════════
     Reads from _data/scholar_metrics.yml (generated by
     fetch_scholar_metrics.py) and renders:
       • Three stat cards: Citations / h-index / i10-index
       • A year-by-year bar chart (pure SVG, no external library)
     ═══════════════════════════════════════════════════════════════ -->

{% assign m = site.data.scholar_metrics %}

<div class="rm-wrapper">

  <!-- ── Stat Cards ────────────────────────────────────────────── -->
  <div class="rm-cards">

    <div class="rm-card rm-card--citations">
      <span class="rm-card__value">{{ m.citations | default: "–" }}</span>
      <span class="rm-card__label">Citations</span>
    </div>

    <div class="rm-card rm-card--hindex">
      <span class="rm-card__value">{{ m.h_index | default: "–" }}</span>
      <span class="rm-card__label">h-index</span>
    </div>

    <div class="rm-card rm-card--i10">
      <span class="rm-card__value">{{ m.i10_index | default: "–" }}</span>
      <span class="rm-card__label">i10-index</span>
    </div>

  </div>

  <!-- ── Bar Chart: Citations per Year ─────────────────────────── -->
  {% if m.cites_by_year %}
  <div class="rm-chart-wrap">
    <h4 class="rm-chart-title">Citations per Year</h4>

    {%- comment -%}
      Find the maximum value for bar scaling.
      Jekyll Liquid has no built-in max filter, so we iterate manually.
    {%- endcomment -%}
    {% assign max_val = 0 %}
    {% for pair in m.cites_by_year %}
      {% assign val = pair[1] | plus: 0 %}
      {% if val > max_val %}{% assign max_val = val %}{% endif %}
    {% endfor %}

    <div class="rm-bars" role="list" aria-label="Citations per year bar chart">
      {% for pair in m.cites_by_year %}
        {% assign year  = pair[0] %}
        {% assign count = pair[1] | plus: 0 %}
        {% if max_val > 0 %}
          {% assign pct = count | times: 100 | divided_by: max_val %}
        {% else %}
          {% assign pct = 0 %}
        {% endif %}

        <div class="rm-bar-group" role="listitem" title="{{ year }}: {{ count }} citations">
          <div class="rm-bar-track">
            <div class="rm-bar-fill" style="height: {{ pct }}%;"></div>
          </div>
          <span class="rm-bar-count">{{ count }}</span>
          <span class="rm-bar-year">{{ year }}</span>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- ── Source / Update Info ───────────────────────────────────── -->
  <p class="rm-source">
    {% if m.source == "Google Scholar" %}
      <a href="https://scholar.google.com/citations?user=nQwHS1gAAAAJ"
         target="_blank" rel="noopener">
        <img src="/images/icons/google_scholar.png"
             alt="Google Scholar"
             style="height:14px; vertical-align:middle; margin-right:4px;">Google Scholar
      </a>
    {% else %}
      <a href="https://openalex.org/A5085505896" target="_blank" rel="noopener">OpenAlex</a>
    {% endif %}
    &nbsp;·&nbsp; Updated {{ m.updated | default: "recently" }}
  </p>

</div>

<!-- ── Styles (scoped to .rm-* classes) ──────────────────────── -->
<style>
/* Wrapper */
.rm-wrapper {
  margin: 1.5rem 0 2rem;
}

/* ── Stat Cards ── */
.rm-cards {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.rm-card {
  flex: 1 1 120px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 1rem 0.75rem;
  border-radius: 10px;
  background: #f5f8ff;
  border: 1px solid #dce5f5;
  text-align: center;
  transition: box-shadow 0.2s;
}
.rm-card:hover { box-shadow: 0 4px 14px rgba(0,0,0,.10); }

.rm-card__value {
  font-size: 2rem;
  font-weight: 700;
  line-height: 1;
  color: #2c5fa8;
}
.rm-card__label {
  margin-top: 0.35rem;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: .06em;
  color: #666;
}

/* Accent colours per card type */
.rm-card--citations .rm-card__value { color: #2c5fa8; }
.rm-card--hindex    .rm-card__value { color: #c07c00; }
.rm-card--i10       .rm-card__value { color: #2a7a3b; }

/* ── Bar Chart ── */
.rm-chart-wrap {
  margin-bottom: 0.5rem;
}
.rm-chart-title {
  font-size: 0.9rem;
  font-weight: 600;
  color: #444;
  margin: 0 0 0.6rem;
  text-transform: uppercase;
  letter-spacing: .05em;
}

.rm-bars {
  display: flex;
  align-items: flex-end;
  gap: 6px;
  height: 120px;
  padding-bottom: 28px;  /* room for year labels */
  position: relative;
}

.rm-bar-group {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  position: relative;
}

.rm-bar-track {
  flex: 1;
  width: 100%;
  display: flex;
  align-items: flex-end;
}

.rm-bar-fill {
  width: 100%;
  background: linear-gradient(to top, #3a6bc4, #7aa3e5);
  border-radius: 3px 3px 0 0;
  min-height: 3px;
  transition: height 0.4s ease;
}

.rm-bar-count {
  position: absolute;
  bottom: 16px;
  font-size: 0.6rem;
  color: #555;
  white-space: nowrap;
}

.rm-bar-year {
  position: absolute;
  bottom: 0;
  font-size: 0.62rem;
  color: #888;
  white-space: nowrap;
}

/* ── Source line ── */
.rm-source {
  font-size: 0.72rem;
  color: #999;
  margin-top: 0.4rem;
}
.rm-source a { color: #888; text-decoration: underline dotted; }

/* ── Responsive ── */
@media (max-width: 480px) {
  .rm-card__value  { font-size: 1.5rem; }
  .rm-bars         { gap: 3px; }
  .rm-bar-count    { font-size: 0.5rem; }
  .rm-bar-year     { font-size: 0.5rem; }
}
</style>